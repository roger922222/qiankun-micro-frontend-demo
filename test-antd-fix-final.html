<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antd + qiankun æ²™ç®±å…¼å®¹æ€§ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #1890ff;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f2f5;
            border-radius: 4px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .success { color: #52c41a; }
        .error { color: #f5222d; }
        .warning { color: #faad14; }
        
        .micro-app-container {
            border: 2px solid #d9d9d9;
            border-radius: 6px;
            min-height: 500px;
            position: relative;
            background: #fafafa;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 0 8px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .btn.primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .btn.primary:hover {
            background: #40a9ff;
        }
        
        .log-container {
            margin-top: 20px;
            padding: 15px;
            background: #f6f6f6;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-item {
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-time {
            color: #666;
            margin-right: 8px;
        }
        
        .log-level {
            margin-right: 8px;
            padding: 2px 6px;
            border-radius: 2px;
            color: white;
            font-size: 10px;
        }
        
        .log-info { background: #1890ff; }
        .log-error { background: #f5222d; }
        .log-warn { background: #faad14; }
        .log-success { background: #52c41a; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ”§ Antd + qiankun æ²™ç®±å…¼å®¹æ€§ä¿®å¤æµ‹è¯•</h1>
            <p>æµ‹è¯• React å­åº”ç”¨åœ¨ qiankun æ²™ç®±ç¯å¢ƒä¸­çš„ Antd æ ·å¼æ³¨å…¥é—®é¢˜ä¿®å¤</p>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-label">qiankun çŠ¶æ€</div>
                <div class="status-value" id="qiankun-status">æ£€æµ‹ä¸­...</div>
            </div>
            <div class="status-item">
                <div class="status-label">å­åº”ç”¨çŠ¶æ€</div>
                <div class="status-value" id="app-status">æœªåŠ è½½</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ ·å¼æ³¨å…¥</div>
                <div class="status-value" id="style-status">æœªæµ‹è¯•</div>
            </div>
            <div class="status-item">
                <div class="status-label">DOM æ“ä½œ</div>
                <div class="status-value" id="dom-status">æœªæµ‹è¯•</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn primary" onclick="loadApp()">ğŸš€ åŠ è½½å­åº”ç”¨</button>
            <button class="btn" onclick="unloadApp()">ğŸ›‘ å¸è½½å­åº”ç”¨</button>
            <button class="btn" onclick="testAntdComponents()">ğŸ§ª æµ‹è¯• Antd ç»„ä»¶</button>
            <button class="btn" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="micro-app-react-user-management" class="micro-app-container">
            <div class="loading">
                <div>ğŸ“¦ ç­‰å¾…å­åº”ç”¨åŠ è½½...</div>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    ç‚¹å‡»"åŠ è½½å­åº”ç”¨"æŒ‰é’®å¼€å§‹æµ‹è¯•
                </div>
            </div>
        </div>
        
        <div class="log-container">
            <div style="margin-bottom: 10px; font-weight: bold;">ğŸ“‹ å®æ—¶æ—¥å¿—</div>
            <div id="log-content"></div>
        </div>
    </div>

    <script src="https://unpkg.com/qiankun@2.10.16/dist/index.umd.min.js"></script>
    <script>
        let app = null;
        let isLoaded = false;
        
        // æ—¥å¿—ç³»ç»Ÿ
        function log(level, message, data = null) {
            const time = new Date().toLocaleTimeString();
            const logContent = document.getElementById('log-content');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = time;
            
            const levelSpan = document.createElement('span');
            levelSpan.className = `log-level log-${level}`;
            levelSpan.textContent = level.toUpperCase();
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message + (data ? ` ${JSON.stringify(data)}` : '');
            
            logItem.appendChild(timeSpan);
            logItem.appendChild(levelSpan);
            logItem.appendChild(messageSpan);
            
            logContent.appendChild(logItem);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(type, status, className = 'success') {
            const element = document.getElementById(`${type}-status`);
            element.textContent = status;
            element.className = `status-value ${className}`;
        }
        
        // é”™è¯¯ç›‘å¬
        window.addEventListener('error', (event) => {
            if (event.message.includes('appendChild') || 
                event.message.includes('Cannot set properties of null')) {
                log('error', `DOM æ“ä½œé”™è¯¯: ${event.message}`);
                updateStatus('dom', 'âŒ DOM é”™è¯¯', 'error');
            } else {
                log('error', `å…¨å±€é”™è¯¯: ${event.message}`);
            }
        });
        
        // æ£€æµ‹ qiankun çŠ¶æ€
        function checkQiankun() {
            if (window.qiankun) {
                log('success', 'qiankun æ¡†æ¶å·²åŠ è½½');
                updateStatus('qiankun', 'âœ… å·²åŠ è½½', 'success');
                return true;
            } else {
                log('error', 'qiankun æ¡†æ¶æœªåŠ è½½');
                updateStatus('qiankun', 'âŒ æœªåŠ è½½', 'error');
                return false;
            }
        }
        
        // åŠ è½½å­åº”ç”¨
        async function loadApp() {
            if (!checkQiankun()) return;
            
            if (isLoaded) {
                log('warn', 'å­åº”ç”¨å·²åŠ è½½ï¼Œè¯·å…ˆå¸è½½');
                return;
            }
            
            try {
                log('info', 'å¼€å§‹åŠ è½½ React ç”¨æˆ·ç®¡ç†å­åº”ç”¨...');
                updateStatus('app', 'ğŸ”„ åŠ è½½ä¸­...', 'warning');
                
                // æ³¨å†Œå­åº”ç”¨
                qiankun.registerMicroApps([{
                    name: 'react-user-management',
                    entry: 'http://localhost:3002/',
                    container: '#micro-app-react-user-management',
                    activeRule: () => true,
                }], {
                    beforeLoad: (app) => {
                        log('info', `å‡†å¤‡åŠ è½½å­åº”ç”¨: ${app.name}`);
                        return Promise.resolve();
                    },
                    beforeMount: (app) => {
                        log('info', `å‡†å¤‡æŒ‚è½½å­åº”ç”¨: ${app.name}`);
                        return Promise.resolve();
                    },
                    afterMount: (app) => {
                        log('success', `å­åº”ç”¨æŒ‚è½½æˆåŠŸ: ${app.name}`);
                        updateStatus('app', 'âœ… å·²åŠ è½½', 'success');
                        updateStatus('style', 'âœ… æ­£å¸¸', 'success');
                        updateStatus('dom', 'âœ… æ­£å¸¸', 'success');
                        isLoaded = true;
                        
                        // æ£€æµ‹æ ·å¼æ³¨å…¥
                        setTimeout(checkStyleInjection, 1000);
                        return Promise.resolve();
                    },
                    beforeUnmount: (app) => {
                        log('info', `å‡†å¤‡å¸è½½å­åº”ç”¨: ${app.name}`);
                        return Promise.resolve();
                    },
                    afterUnmount: (app) => {
                        log('success', `å­åº”ç”¨å¸è½½æˆåŠŸ: ${app.name}`);
                        updateStatus('app', 'âšª æœªåŠ è½½', 'warning');
                        isLoaded = false;
                        return Promise.resolve();
                    }
                });
                
                // å¯åŠ¨ qiankun
                qiankun.start({
                    prefetch: false,
                    singular: true,
                    sandbox: {
                        strictStyleIsolation: false,
                        experimentalStyleIsolation: true
                    }
                });
                
            } catch (error) {
                log('error', `åŠ è½½å­åº”ç”¨å¤±è´¥: ${error.message}`);
                updateStatus('app', 'âŒ åŠ è½½å¤±è´¥', 'error');
            }
        }
        
        // å¸è½½å­åº”ç”¨
        function unloadApp() {
            if (!isLoaded) {
                log('warn', 'å­åº”ç”¨æœªåŠ è½½');
                return;
            }
            
            try {
                log('info', 'å¼€å§‹å¸è½½å­åº”ç”¨...');
                qiankun.unloadMicroApp('react-user-management');
            } catch (error) {
                log('error', `å¸è½½å­åº”ç”¨å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ£€æµ‹æ ·å¼æ³¨å…¥
        function checkStyleInjection() {
            const container = document.getElementById('micro-app-react-user-management');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ Antd æ ·å¼
            const antdStyles = container.querySelectorAll('style[data-token-hash]');
            const portalRoot = container.querySelector('#subapp-portal-root');
            
            if (antdStyles.length > 0) {
                log('success', `å‘ç° ${antdStyles.length} ä¸ª Antd æ ·å¼æ ‡ç­¾`);
                updateStatus('style', 'âœ… å·²æ³¨å…¥', 'success');
            } else {
                log('warn', 'æœªå‘ç° Antd CSS-in-JS æ ·å¼æ ‡ç­¾');
                updateStatus('style', 'âš ï¸ æ— æ ·å¼', 'warning');
            }
            
            if (portalRoot) {
                log('success', 'å‘ç°å¼¹å±‚å®¹å™¨ #subapp-portal-root');
            } else {
                log('warn', 'æœªå‘ç°å¼¹å±‚å®¹å™¨');
            }
        }
        
        // æµ‹è¯• Antd ç»„ä»¶
        function testAntdComponents() {
            if (!isLoaded) {
                log('warn', 'è¯·å…ˆåŠ è½½å­åº”ç”¨');
                return;
            }
            
            log('info', 'å¼€å§‹æµ‹è¯• Antd ç»„ä»¶...');
            
            // æ¨¡æ‹Ÿè§¦å‘ Antd ç»„ä»¶
            const container = document.getElementById('micro-app-react-user-management');
            const buttons = container.querySelectorAll('button');
            
            if (buttons.length > 0) {
                log('info', `å‘ç° ${buttons.length} ä¸ªæŒ‰é’®ï¼Œå°è¯•ç‚¹å‡»æµ‹è¯•`);
                buttons[0].click();
            } else {
                log('warn', 'æœªå‘ç°å¯æµ‹è¯•çš„æŒ‰é’®');
            }
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('log-content').innerHTML = '';
            log('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('info', 'æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            checkQiankun();
        });
    </script>
</body>
</html>