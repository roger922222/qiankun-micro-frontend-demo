# React-App-3 代码对比与配置示例

## 概述

本文档提供了在开发 `sub-apps/react-app-3` 过程中的详细代码对比、配置示例和实现细节，包括错误代码和正确代码的对比，以及完整的配置文件示例。

## 目录

1. [Qiankun生命周期实现对比](#1-qiankun生命周期实现对比)
2. [ES模块导入解决方案](#2-es模块导入解决方案)
3. [路由配置对比](#3-路由配置对比)
4. [状态管理实现](#4-状态管理实现)
5. [构建配置示例](#5-构建配置示例)
6. [样式配置对比](#6-样式配置对比)

---

## 1. Qiankun生命周期实现对比

### 1.1 错误的实现方式

```typescript
// ❌ 错误的 main.tsx 实现
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

let root: any;

// 错误：直接导出生命周期函数，可能导致undefined
export async function bootstrap() {
  console.log('bootstrap');
}

export async function mount(props: any) {
  const container = props.container;
  root = ReactDOM.createRoot(container);
  root.render(<App />);
}

export async function unmount() {
  if (root) {
    root.unmount();
  }
}

// 错误：没有处理独立运行的情况
if (!window.__POWERED_BY_QIANKUN__) {
  mount({});
}
```

### 1.2 正确的实现方式

```typescript
// ✅ 正确的 main.tsx 实现
import React from 'react';
import * as ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { ConfigProvider } from 'antd';
import zhCN from 'antd/locale/zh_CN';
import { HelmetProvider } from 'react-helmet-async';
import { ErrorBoundary } from 'react-error-boundary';

// 导入样式
import 'antd/dist/reset.css';
import './styles/index.css';

// 导入应用组件
import App from './App';
import ErrorFallback from './components/ErrorFallback';

// 导入Context Provider
import { OrderProvider } from './context/OrderContext';

// 导入共享库
import { globalLogger } from './shared-stub';

// 导入qiankun插件辅助函数
import { createLifecyle, getMicroApp } from 'vite-plugin-legacy-qiankun';

// 全局变量保存 React root 实例，避免重复创建
let reactRoot: any = null;

/**
 * 渲染应用
 */
function render(props?: any) {
  const { container, routerBase } = props || {};
  
  // 在qiankun环境中，直接使用传入的容器，避免错误的querySelector
  let domElement: HTMLElement | null;
  if (window.__POWERED_BY_QIANKUN__) {
    domElement = container;
  } else {
    domElement = document.getElementById('root');
  }
  
  if (!domElement) {
    globalLogger.error('Root element not found', new Error('Root element not found'), { 
      container, 
      hasQiankun: !!window.__POWERED_BY_QIANKUN__ 
    });
    return;
  }

  // 只在第一次或 root 不存在时创建，避免重复创建
  if (!reactRoot) {
    reactRoot = ReactDOM.createRoot(domElement);
  }

  reactRoot.render(
    <React.StrictMode>
      <ErrorBoundary
        FallbackComponent={ErrorFallback}
        onError={(error, errorInfo) => {
          globalLogger.error('React Error Boundary caught an error', error, {
            componentStack: errorInfo.componentStack
          });
        }}
      >
        <OrderProvider>
          <HelmetProvider>
            <ConfigProvider
              locale={zhCN}
              theme={{
                token: {
                  colorPrimary: '#1890ff',
                  borderRadius: 4,
                  fontSize: 14
                }
              }}
            >
              <BrowserRouter basename={routerBase || (window.__POWERED_BY_QIANKUN__ ? '/order-management' : '/')}>
                <App />
              </BrowserRouter>
            </ConfigProvider>
          </HelmetProvider>
        </OrderProvider>
      </ErrorBoundary>
    </React.StrictMode>
  );

  return reactRoot;
}

// 使用插件提供的辅助函数
const microApp = getMicroApp('react-order-management');

// 判断是否在qiankun环境下运行
if (microApp.__POWERED_BY_QIANKUN__) {
  // 使用createLifecyle导出生命周期函数
  createLifecyle('react-order-management', {
    bootstrap() {
      globalLogger.info('React Order Management app bootstrapped');
    },
    mount(props: any) {
      globalLogger.info('React Order Management app mounting', props);
      
      // 验证挂载参数
      if (!props || !props.container) {
        const error = new Error('Invalid mount props: container is required');
        globalLogger.error('Mount failed', error, { props });
        throw error;
      }
      
      render(props);
    },
    unmount() {
      globalLogger.info('React Order Management app unmounting');
      
      // 使用保存的 root 实例进行卸载
      if (reactRoot) {
        reactRoot.unmount();
        reactRoot = null;
      }
    },
  });
} else {
  // 独立运行模式
  render();
}

// 开发模式下的热更新支持
if ((import.meta as any).hot) {
  (import.meta as any).hot.accept();
}

// 设置全局变量供qiankun使用
declare global {
  interface Window {
    __POWERED_BY_QIANKUN__?: boolean;
    __INJECTED_PUBLIC_PATH_BY_QIANKUN__?: string;
  }
}

// 动态设置publicPath
if (window.__POWERED_BY_QIANKUN__) {
  // Vite不需要设置__webpack_public_path__
  // 这是webpack特有的配置
}
```

### 1.3 关键改进点对比

| 方面 | 错误实现 | 正确实现 |
|------|----------|----------|
| 生命周期导出 | 直接导出函数 | 使用 `createLifecyle` 辅助函数 |
| 容器处理 | 简单获取 container | 验证容器存在性和类型 |
| 错误处理 | 无错误处理 | 完整的错误边界和日志 |
| 资源管理 | 可能重复创建 root | 正确管理 React root 实例 |
| 独立运行 | 简单判断 | 完整的环境检测和渲染 |

---

## 2. ES模块导入解决方案

### 2.1 问题代码

```typescript
// ❌ 错误：导入不存在的共享模块
import { createMicroAppNavigation } from '@shared/communication/navigation/micro-app-integration';
import { globalEventBus, globalStateManager } from '@shared/communication';

// ❌ 错误：导入路径不正确
import { EVENT_TYPES } from '../shared/constants';

// 使用时出错
globalEventBus.onAny((event) => {
  console.log('收到事件:', event);
}); // TypeError: globalEventBus.onAny is not a function
```

### 2.2 解决方案代码

#### 2.2.1 创建本地存根文件

```typescript
// src/shared-stub.ts
/**
 * 共享库存根实现
 * 提供基本的事件总线和状态管理功能
 */

// 事件类型定义
export const EVENT_TYPES = {
  APP_READY: 'APP_READY',
  THEME_CHANGE: 'THEME_CHANGE',
  USER_LOGOUT: 'USER_LOGOUT',
  LANGUAGE_CHANGE: 'LANGUAGE_CHANGE',
  ROUTE_CHANGE: 'ROUTE_CHANGE',
  ORDER_CREATED: 'ORDER_CREATED',
  ORDER_UPDATED: 'ORDER_UPDATED',
  ORDER_DELETED: 'ORDER_DELETED'
} as const;

// 简单的事件总线实现
class SimpleEventBus {
  private listeners: Record<string, Function[]> = {};

  /**
   * 注册事件监听器
   */
  on(eventType: string, callback: Function): void {
    if (!this.listeners[eventType]) {
      this.listeners[eventType] = [];
    }
    this.listeners[eventType].push(callback);
  }

  /**
   * 移除事件监听器
   */
  off(eventType: string, callback: Function): void {
    if (this.listeners[eventType]) {
      this.listeners[eventType] = this.listeners[eventType].filter(
        listener => listener !== callback
      );
    }
  }

  /**
   * 发送事件
   */
  emit(event: any): void {
    const eventType = event.type;
    if (this.listeners[eventType]) {
      this.listeners[eventType].forEach(callback => {
        try {
          callback(event);
        } catch (error) {
          console.error('Event listener error:', error);
        }
      });
    }
    
    // 支持通配符监听器
    if (this.listeners['*']) {
      this.listeners['*'].forEach(callback => {
        try {
          callback(event);
        } catch (error) {
          console.error('Wildcard event listener error:', error);
        }
      });
    }
  }

  /**
   * 监听所有事件（兼容性方法）
   */
  onAny(callback: (event: any) => void): () => void {
    this.on('*', callback);
    return () => this.off('*', callback);
  }
}

// 简单的日志记录器
class SimpleLogger {
  private prefix = '[OrderManagement]';

  info(message: string, data?: any): void {
    console.log(`${this.prefix} [INFO] ${message}`, data || '');
  }

  error(message: string, error?: Error, data?: any): void {
    console.error(`${this.prefix} [ERROR] ${message}`, error, data || '');
  }

  warn(message: string, data?: any): void {
    console.warn(`${this.prefix} [WARN] ${message}`, data || '');
  }

  debug(message: string, data?: any): void {
    if (process.env.NODE_ENV === 'development') {
      console.debug(`${this.prefix} [DEBUG] ${message}`, data || '');
    }
  }
}

// 简单的状态管理器
class SimpleStateManager {
  private state: Record<string, any> = {};
  private subscribers: Function[] = [];

  /**
   * 设置状态
   */
  setState(key: string, value: any): void {
    const oldValue = this.state[key];
    this.state[key] = value;
    
    // 通知订阅者
    this.subscribers.forEach(callback => {
      try {
        callback({ key, value, oldValue });
      } catch (error) {
        console.error('State subscriber error:', error);
      }
    });
  }

  /**
   * 获取状态
   */
  getState(key: string): any {
    return this.state[key];
  }

  /**
   * 订阅状态变化
   */
  subscribe(callback: Function): () => void {
    this.subscribers.push(callback);
    return () => {
      this.subscribers = this.subscribers.filter(sub => sub !== callback);
    };
  }

  /**
   * 取消订阅（兼容性方法）
   */
  unsubscribe(callback: Function): void {
    this.subscribers = this.subscribers.filter(sub => sub !== callback);
  }
}

// 导出实例
export const globalEventBus = new SimpleEventBus();
export const globalLogger = new SimpleLogger();
export const globalStateManager = new SimpleStateManager();

// 类型导出
export type EventType = keyof typeof EVENT_TYPES;
export type EventData = {
  type: EventType;
  source: string;
  timestamp: string;
  id: string;
  data?: any;
};

export type StateChangeEvent = {
  key: string;
  value: any;
  oldValue: any;
};

// 工具函数
export const createEvent = (
  type: EventType,
  source: string,
  data?: any
): EventData => ({
  type,
  source,
  timestamp: new Date().toISOString(),
  id: `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
  data
});

// 导出默认配置
export const DEFAULT_CONFIG = {
  appName: 'react-order-management',
  version: '1.0.0',
  features: ['order-management', 'customer-management', 'payment-tracking'],
  theme: {
    primaryColor: '#1890ff',
    borderRadius: 4,
    fontSize: 14
  }
};
```

#### 2.2.2 正确的导入使用

```typescript
// src/App.tsx
import React, { useEffect } from 'react';
import { Routes, Route, Navigate } from 'react-router-dom';
import { Layout, message } from 'antd';
import { Helmet } from 'react-helmet-async';

// 正确导入本地存根
import { 
  globalEventBus, 
  globalLogger, 
  EVENT_TYPES,
  createEvent,
  DEFAULT_CONFIG
} from './shared-stub';

// 导入页面组件
import OrderList from './pages/OrderList';
import OrderDetail from './pages/OrderDetail';
import OrderStats from './pages/OrderStats';

// 导入Context
import { useOrderContext } from './context/OrderContext';

// 导入样式
import './styles/App.css';

const { Content } = Layout;

const App: React.FC = () => {
  const { actions } = useOrderContext();

  useEffect(() => {
    globalLogger.info('Order Management App mounted');

    // 监听全局事件
    const handleGlobalEvent = (event: any) => {
      globalLogger.info('Received global event', event);
      
      switch (event.type) {
        case EVENT_TYPES.THEME_CHANGE:
          document.documentElement.setAttribute('data-theme', event.data.theme);
          break;
          
        case EVENT_TYPES.USER_LOGOUT:
          actions.reset();
          message.info('用户已登出，数据已清理');
          break;
          
        case EVENT_TYPES.LANGUAGE_CHANGE:
          message.info(`语言已切换为: ${event.data.language}`);
          break;
          
        default:
          break;
      }
    };

    // 注册事件监听器
    globalEventBus.on(EVENT_TYPES.THEME_CHANGE, handleGlobalEvent);
    globalEventBus.on(EVENT_TYPES.USER_LOGOUT, handleGlobalEvent);
    globalEventBus.on(EVENT_TYPES.LANGUAGE_CHANGE, handleGlobalEvent);

    // 发送应用就绪事件
    const readyEvent = createEvent(
      EVENT_TYPES.APP_READY,
      DEFAULT_CONFIG.appName,
      {
        appName: DEFAULT_CONFIG.appName,
        version: DEFAULT_CONFIG.version,
        features: DEFAULT_CONFIG.features
      }
    );
    globalEventBus.emit(readyEvent);

    // 初始化示例数据
    initializeSampleData();

    return () => {
      globalEventBus.off(EVENT_TYPES.THEME_CHANGE, handleGlobalEvent);
      globalEventBus.off(EVENT_TYPES.USER_LOGOUT, handleGlobalEvent);
      globalEventBus.off(EVENT_TYPES.LANGUAGE_CHANGE, handleGlobalEvent);
      
      globalLogger.info('Order Management App unmounted');
    };
  }, [actions]);

  // ... 其他代码
};

export default App;
```

---

## 3. 路由配置对比

### 3.1 错误的路由配置

```typescript
// ❌ 错误：没有考虑qiankun环境
import { BrowserRouter } from 'react-router-dom';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<OrderList />} />
        <Route path="/orders/:id" element={<OrderDetail />} />
      </Routes>
    </BrowserRouter>
  );
}

// ❌ 错误：渲染函数中没有处理basename
function render(props: any) {
  const container = props.container;
  const root = ReactDOM.createRoot(container);
  root.render(<App />);
}
```

### 3.2 正确的路由配置

```typescript
// ✅ 正确：考虑qiankun环境的路由配置
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';

function render(props?: any) {
  const { container, routerBase } = props || {};
  
  // 确定路由基础路径
  const basename = routerBase || (window.__POWERED_BY_QIANKUN__ ? '/order-management' : '/');
  
  // 获取容器元素
  let domElement: HTMLElement | null;
  if (window.__POWERED_BY_QIANKUN__) {
    domElement = container;
  } else {
    domElement = document.getElementById('root');
  }
  
  if (!domElement) {
    globalLogger.error('Root element not found');
    return;
  }

  if (!reactRoot) {
    reactRoot = ReactDOM.createRoot(domElement);
  }

  reactRoot.render(
    <React.StrictMode>
      <ErrorBoundary FallbackComponent={ErrorFallback}>
        <OrderProvider>
          <HelmetProvider>
            <ConfigProvider locale={zhCN}>
              <BrowserRouter basename={basename}>
                <App />
              </BrowserRouter>
            </ConfigProvider>
          </HelmetProvider>
        </OrderProvider>
      </ErrorBoundary>
    </React.StrictMode>
  );

  return reactRoot;
}

// App组件中的路由定义
const App: React.FC = () => {
  return (
    <Layout className="order-app-layout">
      <Content className="order-app-main">
        <div className="order-app-container">
          <Routes>
            <Route path="/" element={<Navigate to="/orders" replace />} />
            <Route path="/orders" element={<OrderList />} />
            <Route path="/orders/:id" element={<OrderDetail />} />
            <Route path="/stats" element={<OrderStats />} />
            <Route path="*" element={<Navigate to="/orders" replace />} />
          </Routes>
        </div>
      </Content>
    </Layout>
  );
};
```

### 3.3 路由导航组件示例

```typescript
// src/components/Layout/AppSidebar.tsx
import React from 'react';
import { Layout, Menu } from 'antd';
import { useNavigate, useLocation } from 'react-router-dom';
import {
  UnorderedListOutlined,
  BarChartOutlined
} from '@ant-design/icons';

const { Sider } = Layout;

const AppSidebar: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();

  const menuItems = [
    {
      key: '/orders',
      icon: <UnorderedListOutlined />,
      label: '订单列表',
      onClick: () => navigate('/orders'),
    },
    {
      key: '/stats',
      icon: <BarChartOutlined />,
      label: '订单统计',
      onClick: () => navigate('/stats'),
    }
  ];

  // 智能选择当前菜单项
  const selectedKey = menuItems.find(item => 
    location.pathname.startsWith(item.key)
  )?.key || '/orders';

  return (
    <Sider width={200} style={{ background: '#fff' }}>
      <Menu
        mode="inline"
        selectedKeys={[selectedKey]}
        items={menuItems}
        style={{ height: '100%', borderRight: 0 }}
      />
    </Sider>
  );
};

export default AppSidebar;
```

---

## 4. 状态管理实现

### 4.1 Context API 完整实现

```typescript
// src/context/OrderContext.tsx
import React, { createContext, useContext, useReducer, ReactNode } from 'react';

// 订单状态类型定义
export type OrderStatus = 'pending' | 'confirmed' | 'processing' | 'shipped' | 'completed' | 'cancelled';
export type PaymentStatus = 'unpaid' | 'paid' | 'refunded';
export type PaymentMethod = 'alipay' | 'wechat' | 'credit_card' | 'bank_transfer';

export interface Address {
  id: string;
  name: string;
  phone: string;
  province: string;
  city: string;
  district: string;
  street: string;
  zipCode: string;
  isDefault: boolean;
}

export interface OrderItem {
  id: string;
  productId: string;
  productName: string;
  productImage?: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
  specifications?: Record<string, any>;
}

export interface Order {
  id: string;
  orderNumber: string;
  createdAt: string;
  updatedAt: string;
  customerId: string;
  customerName: string;
  customerEmail: string;
  customerPhone: string;
  items: OrderItem[];
  totalAmount: number;
  status: OrderStatus;
  paymentStatus: PaymentStatus;
  paymentMethod: PaymentMethod;
  shippingAddress: Address;
  billingAddress: Address;
  notes?: string;
}

interface OrderState {
  orders: Order[];
  currentOrder: Order | null;
  loading: boolean;
  error: string | null;
  filters: {
    status?: OrderStatus;
    paymentStatus?: PaymentStatus;
    dateRange?: [string, string];
    searchKeyword?: string;
  };
  pagination: {
    current: number;
    pageSize: number;
    total: number;
  };
}

// Action 类型定义
type OrderAction =
  | { type: 'SET_ORDERS'; payload: Order[] }
  | { type: 'ADD_ORDER'; payload: Order }
  | { type: 'UPDATE_ORDER'; payload: { id: string; updates: Partial<Order> } }
  | { type: 'DELETE_ORDER'; payload: string }
  | { type: 'SET_CURRENT_ORDER'; payload: Order | null }
  | { type: 'SET_LOADING'; payload: boolean }
  | { type: 'SET_ERROR'; payload: string | null }
  | { type: 'SET_FILTERS'; payload: Partial<OrderState['filters']> }
  | { type: 'SET_PAGINATION'; payload: Partial<OrderState['pagination']> }
  | { type: 'RESET' };

// Reducer 函数
function orderReducer(state: OrderState, action: OrderAction): OrderState {
  switch (action.type) {
    case 'SET_ORDERS':
      return { 
        ...state, 
        orders: action.payload, 
        loading: false, 
        error: null,
        pagination: {
          ...state.pagination,
          total: action.payload.length
        }
      };
    
    case 'ADD_ORDER':
      const newOrders = [...state.orders, action.payload];
      return { 
        ...state, 
        orders: newOrders,
        pagination: {
          ...state.pagination,
          total: newOrders.length
        }
      };
    
    case 'UPDATE_ORDER':
      return {
        ...state,
        orders: state.orders.map(order =>
          order.id === action.payload.id
            ? { ...order, ...action.payload.updates, updatedAt: new Date().toISOString() }
            : order
        ),
        currentOrder: state.currentOrder?.id === action.payload.id
          ? { ...state.currentOrder, ...action.payload.updates, updatedAt: new Date().toISOString() }
          : state.currentOrder
      };
    
    case 'DELETE_ORDER':
      const filteredOrders = state.orders.filter(order => order.id !== action.payload);
      return {
        ...state,
        orders: filteredOrders,
        currentOrder: state.currentOrder?.id === action.payload ? null : state.currentOrder,
        pagination: {
          ...state.pagination,
          total: filteredOrders.length
        }
      };
    
    case 'SET_CURRENT_ORDER':
      return { ...state, currentOrder: action.payload };
    
    case 'SET_LOADING':
      return { ...state, loading: action.payload };
    
    case 'SET_ERROR':
      return { ...state, error: action.payload, loading: false };
    
    case 'SET_FILTERS':
      return { 
        ...state, 
        filters: { ...state.filters, ...action.payload },
        pagination: { ...state.pagination, current: 1 } // 重置到第一页
      };
    
    case 'SET_PAGINATION':
      return { 
        ...state, 
        pagination: { ...state.pagination, ...action.payload } 
      };
    
    case 'RESET':
      return initialState;
    
    default:
      return state;
  }
}

// 初始状态
const initialState: OrderState = {
  orders: [],
  currentOrder: null,
  loading: false,
  error: null,
  filters: {},
  pagination: {
    current: 1,
    pageSize: 10,
    total: 0
  }
};

// Context 创建
const OrderContext = createContext<{
  state: OrderState;
  actions: {
    setOrders: (orders: Order[]) => void;
    addOrder: (order: Order) => void;
    updateOrder: (id: string, updates: Partial<Order>) => void;
    deleteOrder: (id: string) => void;
    setCurrentOrder: (order: Order | null) => void;
    setLoading: (loading: boolean) => void;
    setError: (error: string | null) => void;
    setFilters: (filters: Partial<OrderState['filters']>) => void;
    setPagination: (pagination: Partial<OrderState['pagination']>) => void;
    reset: () => void;
    // 业务逻辑方法
    getOrderById: (id: string) => Order | undefined;
    getFilteredOrders: () => Order[];
    getOrderStats: () => {
      total: number;
      byStatus: Record<OrderStatus, number>;
      byPaymentStatus: Record<PaymentStatus, number>;
      totalAmount: number;
    };
  };
} | null>(null);

// Provider 组件
export const OrderProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(orderReducer, initialState);

  const actions = {
    setOrders: (orders: Order[]) => dispatch({ type: 'SET_ORDERS', payload: orders }),
    addOrder: (order: Order) => dispatch({ type: 'ADD_ORDER', payload: order }),
    updateOrder: (id: string, updates: Partial<Order>) => 
      dispatch({ type: 'UPDATE_ORDER', payload: { id, updates } }),
    deleteOrder: (id: string) => dispatch({ type: 'DELETE_ORDER', payload: id }),
    setCurrentOrder: (order: Order | null) => 
      dispatch({ type: 'SET_CURRENT_ORDER', payload: order }),
    setLoading: (loading: boolean) => dispatch({ type: 'SET_LOADING', payload: loading }),
    setError: (error: string | null) => dispatch({ type: 'SET_ERROR', payload: error }),
    setFilters: (filters: Partial<OrderState['filters']>) => 
      dispatch({ type: 'SET_FILTERS', payload: filters }),
    setPagination: (pagination: Partial<OrderState['pagination']>) => 
      dispatch({ type: 'SET_PAGINATION', payload: pagination }),
    reset: () => dispatch({ type: 'RESET' }),

    // 业务逻辑方法
    getOrderById: (id: string): Order | undefined => {
      return state.orders.find(order => order.id === id);
    },

    getFilteredOrders: (): Order[] => {
      let filtered = [...state.orders];
      
      // 状态筛选
      if (state.filters.status) {
        filtered = filtered.filter(order => order.status === state.filters.status);
      }
      
      // 支付状态筛选
      if (state.filters.paymentStatus) {
        filtered = filtered.filter(order => order.paymentStatus === state.filters.paymentStatus);
      }
      
      // 关键词搜索
      if (state.filters.searchKeyword) {
        const keyword = state.filters.searchKeyword.toLowerCase();
        filtered = filtered.filter(order => 
          order.orderNumber.toLowerCase().includes(keyword) ||
          order.customerName.toLowerCase().includes(keyword) ||
          order.customerEmail.toLowerCase().includes(keyword)
        );
      }
      
      // 日期范围筛选
      if (state.filters.dateRange) {
        const [startDate, endDate] = state.filters.dateRange;
        filtered = filtered.filter(order => {
          const orderDate = new Date(order.createdAt);
          return orderDate >= new Date(startDate) && orderDate <= new Date(endDate);
        });
      }
      
      return filtered;
    },

    getOrderStats: () => {
      const orders = state.orders;
      const stats = {
        total: orders.length,
        byStatus: {} as Record<OrderStatus, number>,
        byPaymentStatus: {} as Record<PaymentStatus, number>,
        totalAmount: 0
      };

      // 初始化计数器
      const statuses: OrderStatus[] = ['pending', 'confirmed', 'processing', 'shipped', 'completed', 'cancelled'];
      const paymentStatuses: PaymentStatus[] = ['unpaid', 'paid', 'refunded'];
      
      statuses.forEach(status => stats.byStatus[status] = 0);
      paymentStatuses.forEach(status => stats.byPaymentStatus[status] = 0);

      // 统计数据
      orders.forEach(order => {
        stats.byStatus[order.status]++;
        stats.byPaymentStatus[order.paymentStatus]++;
        if (order.paymentStatus === 'paid') {
          stats.totalAmount += order.totalAmount;
        }
      });

      return stats;
    }
  };

  return (
    <OrderContext.Provider value={{ state, actions }}>
      {children}
    </OrderContext.Provider>
  );
};

// Hook
export const useOrderContext = () => {
  const context = useContext(OrderContext);
  if (!context) {
    throw new Error('useOrderContext must be used within an OrderProvider');
  }
  return context;
};
```

---

## 5. 构建配置示例

### 5.1 package.json 配置

```json
{
  "name": "react-order-management",
  "version": "1.0.0",
  "description": "基于 React + Context API 的完整订单管理系统",
  "type": "module",
  "scripts": {
    "dev": "vite --port 3003 --host 0.0.0.0",
    "build": "tsc && vite build",
    "preview": "vite preview --port 3003",
    "type-check": "tsc --noEmit",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.8.1",
    "antd": "^5.2.1",
    "react-helmet-async": "^1.3.0",
    "react-error-boundary": "^3.1.4",
    "@ant-design/icons": "^5.0.1"
  },
  "devDependencies": {
    "@types/react": "^18.0.27",
    "@types/react-dom": "^18.0.10",
    "@vitejs/plugin-react": "^3.1.0",
    "typescript": "^4.9.4",
    "vite": "^4.1.0",
    "vite-plugin-legacy-qiankun": "^0.1.0",
    "eslint": "^8.35.0",
    "@typescript-eslint/eslint-plugin": "^5.54.0",
    "@typescript-eslint/parser": "^5.54.0",
    "eslint-plugin-react": "^7.32.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "vitest": "^0.29.1",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^5.16.5"
  }
}
```

### 5.2 vite.config.ts 配置

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import legacy from 'vite-plugin-legacy-qiankun';
import path from 'path';

export default defineConfig({
  plugins: [
    react(),
    legacy('react-order-management', {
      devSandbox: true
    })
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@components': path.resolve(__dirname, 'src/components'),
      '@pages': path.resolve(__dirname, 'src/pages'),
      '@context': path.resolve(__dirname, 'src/context'),
      '@utils': path.resolve(__dirname, 'src/utils'),
      '@styles': path.resolve(__dirname, 'src/styles')
    }
  },
  server: {
    port: 3003,
    host: '0.0.0.0',
    cors: true,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  },
  build: {
    target: 'esnext',
    minify: false,
    cssCodeSplit: false,
    rollupOptions: {
      output: {
        format: 'umd',
        entryFileNames: 'js/[name].[hash].js',
        chunkFileNames: 'js/[name].[hash].js',
        assetFileNames: (assetInfo) => {
          if (assetInfo.name?.endsWith('.css')) {
            return 'css/[name].[hash].[ext]';
          }
          return 'assets/[name].[hash].[ext]';
        }
      }
    }
  },
  define: {
    'process.env': process.env
  },
  css: {
    preprocessorOptions: {
      less: {
        javascriptEnabled: true,
        modifyVars: {
          '@primary-color': '#1890ff',
          '@border-radius-base': '4px',
          '@font-size-base': '14px'
        }
      }
    },
    modules: {
      localsConvention: 'camelCase'
    }
  }
});
```

### 5.3 tsconfig.json 配置

```json
{
  "compilerOptions": {
    "target": "ESNext",
    "lib": ["DOM", "DOM.Iterable", "ESNext"],
    "allowJs": false,
    "skipLibCheck": true,
    "esModuleInterop": false,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"],
      "@pages/*": ["src/pages/*"],
      "@context/*": ["src/context/*"],
      "@utils/*": ["src/utils/*"],
      "@styles/*": ["src/styles/*"]
    },
    "types": ["vite/client", "@testing-library/jest-dom"]
  },
  "include": [
    "src",
    "vite.config.ts"
  ],
  "exclude": [
    "node_modules",
    "dist"
  ]
}
```

### 5.4 ESLint 配置

```json
{
  "env": {
    "browser": true,
    "es2020": true
  },
  "extends": [
    "eslint:recommended",
    "@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaFeatures": {
      "jsx": true
    },
    "ecmaVersion": 11,
    "sourceType": "module"
  },
  "plugins": [
    "react",
    "@typescript-eslint"
  ],
  "rules": {
    "react/react-in-jsx-scope": "off",
    "react/prop-types": "off",
    "@typescript-eslint/no-unused-vars": ["error", { "argsIgnorePattern": "^_" }],
    "@typescript-eslint/no-explicit-any": "warn",
    "no-console": ["warn", { "allow": ["warn", "error"] }]
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  }
}
```

---

## 6. 样式配置对比

### 6.1 错误的样式配置

```css
/* ❌ 错误：没有命名空间，可能冲突 */
.container {
  padding: 20px;
}

.header {
  background: white;
}

.list-item {
  border: 1px solid #ccc;
}
```

### 6.2 正确的样式配置

#### 6.2.1 全局样式 (src/styles/index.css)

```css
/* 全局样式重置和基础样式 */
* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* qiankun 环境样式隔离 */
#root {
  min-height: 100vh;
}

/* 主题变量 */
:root {
  --primary-color: #1890ff;
  --success-color: #52c41a;
  --warning-color: #faad14;
  --error-color: #ff4d4f;
  --text-color: #000000d9;
  --text-color-secondary: #00000073;
  --text-color-disabled: #00000040;
  --border-color: #d9d9d9;
  --background-color: #ffffff;
  --background-color-light: #fafafa;
}

/* 暗色主题 */
[data-theme="dark"] {
  --primary-color: #177ddc;
  --text-color: #ffffffd9;
  --text-color-secondary: #ffffff73;
  --text-color-disabled: #ffffff40;
  --border-color: #434343;
  --background-color: #141414;
  --background-color-light: #1f1f1f;
}

/* 应用特定样式 */
.order-management-app {
  color: var(--text-color);
  background: var(--background-color);
  min-height: 100vh;
}
```

#### 6.2.2 应用样式 (src/styles/App.css)

```css
/* 订单管理应用样式 */
.order-app-layout {
  min-height: 100vh;
  background: var(--background-color-light);
}

.order-app-main {
  padding: 24px;
  background: var(--background-color);
  min-height: calc(100vh - 64px);
}

.order-app-container {
  max-width: 1200px;
  margin: 0 auto;
}

/* 订单列表样式 */
.order-list-container {
  background: var(--background-color);
  border-radius: 8px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.order-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.order-list-title {
  margin: 0;
  color: var(--text-color);
  font-size: 20px;
  font-weight: 600;
}

.order-list-filters {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.order-list-table {
  background: var(--background-color);
}

/* 订单详情样式 */
.order-detail-container {
  background: var(--background-color);
  border-radius: 8px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.order-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border-color);
}

.order-detail-section {
  margin-bottom: 24px;
}

.order-detail-section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-color);
}

/* 订单状态样式 */
.order-status-pending {
  color: var(--warning-color);
}

.order-status-confirmed {
  color: var(--primary-color);
}

.order-status-processing {
  color: var(--primary-color);
}

.order-status-shipped {
  color: var(--primary-color);
}

.order-status-completed {
  color: var(--success-color);
}

.order-status-cancelled {
  color: var(--error-color);
}

/* 支付状态样式 */
.payment-status-unpaid {
  color: var(--error-color);
}

.payment-status-paid {
  color: var(--success-color);
}

.payment-status-refunded {
  color: var(--warning-color);
}

/* 订单统计样式 */
.order-stats-container {
  background: var(--background-color);
  border-radius: 8px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.order-stats-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.order-stats-card {
  background: var(--background-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  transition: box-shadow 0.3s;
}

.order-stats-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.order-stats-card-value {
  font-size: 32px;
  font-weight: 600;
  color: var(--primary-color);
  margin-bottom: 8px;
}

.order-stats-card-label {
  font-size: 14px;
  color: var(--text-color-secondary);
}

/* 响应式设计 */
@media (max-width: 768px) {
  .order-app-main {
    padding: 16px;
  }
  
  .order-list-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .order-list-filters {
    flex-direction: column;
    gap: 12px;
  }
  
  .order-detail-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .order-stats-cards {
    grid-template-columns: 1fr;
  }
}

/* 动画效果 */
.fade-in {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-in {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* 加载状态 */
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 200px;
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border-color);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 错误状态 */
.error-container {
  text-align: center;
  padding: 40px;
  color: var(--error-color);
}

.error-message {
  font-size: 16px;
  margin-bottom: 16px;
}

/* 空状态 */
.empty-container {
  text-align: center;
  padding: 40px;
  color: var(--text-color-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-message {
  font-size: 16px;
  margin-bottom: 16px;
}
```

#### 6.2.3 组件样式模块化示例

```css
/* src/components/OrderCard/OrderCard.module.css */
.orderCard {
  background: var(--background-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s;
  cursor: pointer;
}

.orderCard:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: var(--primary-color);
}

.orderHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.orderNumber {
  font-weight: 600;
  color: var(--text-color);
}

.orderStatus {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.orderInfo {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 14px;
  color: var(--text-color-secondary);
}

.orderAmount {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary-color);
  text-align: right;
}

@media (max-width: 768px) {
  .orderInfo {
    grid-template-columns: 1fr;
  }
  
  .orderHeader {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
}
```

## 总结

通过详细的代码对比和配置示例，我们可以看到：

1. **正确的qiankun集成**需要使用插件辅助函数和完善的错误处理
2. **ES模块问题**通过创建本地存根文件得到解决
3. **路由配置**需要考虑微前端环境的特殊性
4. **状态管理**使用Context API提供完整的业务逻辑
5. **构建配置**需要针对微前端进行优化
6. **样式管理**采用命名空间和CSS变量确保隔离和主题支持

这些配置和代码示例为后续开发提供了可靠的参考基础，确保应用在微前端环境中稳定运行。