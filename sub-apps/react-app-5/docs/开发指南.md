# React App 5 开发指南

## 项目概述

React App 5 是一个基于 React 18 + TypeScript + Valtio + Ant Design + Vite 构建的设置中心系统，支持 qiankun 微前端架构。

## 技术栈

- **前端框架**: React 18
- **类型系统**: TypeScript 4.9+
- **状态管理**: Valtio 1.10+
- **UI组件库**: Ant Design 5.2+
- **构建工具**: Vite 4.1+
- **微前端**: qiankun (通过 vite-plugin-legacy-qiankun)
- **样式方案**: CSS + Ant Design主题

## 项目结构

```
sub-apps/react-app-5/
├── docs/                          # 文档目录
│   ├── 问题解决文档.md
│   ├── 开发指南.md
│   ├── API文档.md
│   └── 部署指南.md
├── src/
│   ├── components/                # 组件目录
│   │   ├── Layout/               # 布局组件
│   │   │   ├── AppHeader.tsx     # 应用头部
│   │   │   ├── AppSidebar.tsx    # 侧边栏
│   │   │   └── AppFooter.tsx     # 应用底部
│   │   └── ErrorFallback.tsx     # 错误边界
│   ├── pages/                    # 页面组件
│   │   ├── GeneralSettings.tsx   # 通用设置
│   │   ├── UserProfile.tsx       # 用户配置
│   │   └── SystemConfig.tsx      # 系统配置
│   ├── store/                    # 状态管理
│   │   └── settingsStore.ts      # 设置状态
│   ├── styles/                   # 样式文件
│   │   ├── App.css              # 应用样式
│   │   └── index.css            # 全局样式
│   ├── App.tsx                   # 主应用组件
│   ├── main.tsx                  # 入口文件
│   └── vite-env.d.ts            # Vite类型声明
├── dist/                         # 构建输出
├── node_modules/                 # 依赖包
├── index.html                    # HTML模板
├── package.json                  # 项目配置
├── tsconfig.json                 # TS配置
├── tsconfig.node.json           # Node TS配置
└── vite.config.ts               # Vite配置
```

## 开发环境设置

### 环境要求

- Node.js >= 16.0.0
- npm >= 8.0.0 或 yarn >= 1.22.0
- 现代浏览器支持 ES2020+

### 安装依赖

```bash
cd sub-apps/react-app-5
npm install
```

### 启动开发服务器

```bash
npm run dev
```

应用将在 http://localhost:3005 启动

### 构建生产版本

```bash
npm run build
```

### 预览生产版本

```bash
npm run preview
```

## 开发规范

### 代码风格

#### TypeScript 规范
- 使用严格模式 (`strict: true`)
- 优先使用接口定义类型
- 避免使用 `any` 类型
- 为函数参数和返回值添加类型注解

```typescript
// ✅ 推荐
interface UserInfo {
  id: string;
  name: string;
  email: string;
}

const updateUser = (userInfo: Partial<UserInfo>): void => {
  // 实现逻辑
};

// ❌ 不推荐
const updateUser = (userInfo: any) => {
  // 实现逻辑
};
```

#### React 组件规范
- 使用函数组件 + Hooks
- 组件名使用 PascalCase
- Props 接口以组件名 + Props 命名
- 使用解构赋值接收 props

```typescript
// ✅ 推荐
interface UserProfileProps {
  userId: string;
  onUpdate: (user: UserInfo) => void;
}

const UserProfile: React.FC<UserProfileProps> = ({ userId, onUpdate }) => {
  // 组件实现
};

export default UserProfile;
```

#### 样式规范
- 使用 CSS 类名采用 kebab-case
- 组件样式使用 BEM 命名规范
- 全局样式放在 `src/styles/` 目录
- 组件特定样式可以内联或使用 CSS Modules

```css
/* ✅ 推荐 */
.settings-page {
  padding: 24px;
}

.settings-page__header {
  margin-bottom: 16px;
}

.settings-page__header--primary {
  color: #1890ff;
}
```

### 状态管理规范

#### Valtio 使用规范
- 状态对象使用 `proxy()` 创建
- 状态更新使用直接赋值
- 组件中使用 `useSnapshot()` 获取响应式状态
- 复杂操作封装为 actions

```typescript
// ✅ 推荐
export const settingsStore = proxy<SettingsState>({
  user: { id: '', name: '' },
  loading: false,
});

export const settingsActions = {
  updateUser: (userInfo: Partial<UserInfo>) => {
    Object.assign(settingsStore.user, userInfo);
  },
  
  setLoading: (loading: boolean) => {
    settingsStore.loading = loading;
  },
};

// 组件中使用
const Component: React.FC = () => {
  const settings = useSnapshot(settingsStore);
  
  const handleUpdate = () => {
    settingsActions.updateUser({ name: 'New Name' });
  };
  
  return <div>{settings.user.name}</div>;
};
```

### 组件开发规范

#### 组件结构
```typescript
/**
 * 组件描述
 * 包含功能说明和使用场景
 */

import React from 'react';
// 第三方库导入

// 本地导入

// 类型定义
interface ComponentProps {
  // props 定义
}

// 组件实现
const Component: React.FC<ComponentProps> = ({ prop1, prop2 }) => {
  // Hooks
  
  // 事件处理函数
  
  // 渲染逻辑
  return (
    <div>
      {/* JSX */}
    </div>
  );
};

export default Component;
```

#### 错误处理
- 使用 ErrorBoundary 包装组件
- 关键操作添加 try-catch
- 用户友好的错误提示

```typescript
// ✅ 推荐
const handleSave = async () => {
  try {
    setLoading(true);
    await saveSettings(settings);
    message.success('保存成功');
  } catch (error) {
    message.error('保存失败');
    globalLogger.error('Failed to save settings', error as Error);
  } finally {
    setLoading(false);
  }
};
```

### 路由规范

#### 路由配置
- 使用 React Router v6
- 路由路径使用 kebab-case
- 实现路由懒加载（如需要）

```typescript
// ✅ 推荐
<Routes>
  <Route path="/" element={<Navigate to="/general" replace />} />
  <Route path="/general" element={<GeneralSettings />} />
  <Route path="/profile" element={<UserProfile />} />
  <Route path="/system" element={<SystemConfig />} />
  <Route path="*" element={<Navigate to="/general" replace />} />
</Routes>
```

## API 设计规范

### 状态管理 API

#### settingsStore
全局设置状态，包含用户信息、偏好设置、系统配置等。

```typescript
interface SettingsState {
  user: UserInfo;           // 用户信息
  preferences: UserPreferences; // 用户偏好
  system: SystemConfig;     // 系统配置
  theme: 'light' | 'dark';  // 当前主题
  language: string;         // 当前语言
  loading: boolean;         // 加载状态
  error: string | null;     // 错误信息
  reset: () => void;        // 重置方法
}
```

#### settingsActions
状态操作方法集合。

```typescript
export const settingsActions = {
  updateUser: (userInfo: Partial<UserInfo>) => void;
  updatePreferences: (preferences: Partial<UserPreferences>) => void;
  updateSystem: (systemConfig: Partial<SystemConfig>) => void;
  setTheme: (theme: 'light' | 'dark') => void;
  setLanguage: (language: string) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
  reset: () => void;
  saveToStorage: () => void;
  loadFromStorage: () => void;
};
```

### 组件 API

#### 页面组件
所有页面组件都应该：
- 实现响应式设计
- 支持表单验证
- 提供加载状态
- 处理错误情况
- 支持数据持久化

#### 布局组件
- **AppHeader**: 应用头部，包含Logo、用户信息、主题切换
- **AppSidebar**: 侧边栏导航，包含菜单项和路由跳转
- **AppFooter**: 应用底部，显示版权信息和系统状态

## 测试规范

### 单元测试
使用 Vitest 进行单元测试：

```typescript
// ✅ 推荐测试结构
import { describe, it, expect, beforeEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import Component from './Component';

describe('Component', () => {
  beforeEach(() => {
    // 测试前置条件
  });

  it('should render correctly', () => {
    render(<Component />);
    expect(screen.getByText('Expected Text')).toBeInTheDocument();
  });

  it('should handle user interaction', () => {
    render(<Component />);
    const button = screen.getByRole('button');
    fireEvent.click(button);
    // 断言结果
  });
});
```

### 集成测试
- 测试组件间交互
- 测试状态管理流程
- 测试路由跳转

### E2E 测试
- 测试完整用户流程
- 测试跨浏览器兼容性
- 测试响应式设计

## 性能优化

### 代码分割
```typescript
// 路由级别的代码分割
const LazyComponent = React.lazy(() => import('./LazyComponent'));

<Suspense fallback={<Loading />}>
  <LazyComponent />
</Suspense>
```

### 状态优化
- 避免不必要的状态更新
- 使用 useMemo 和 useCallback 优化计算
- 合理使用 Valtio 的响应式特性

### 资源优化
- 图片懒加载
- 组件懒加载
- 第三方库按需引入

## 调试技巧

### 开发工具
- React DevTools
- Redux DevTools (如果使用)
- Vite DevTools
- 浏览器开发者工具

### 日志系统
```typescript
// 使用统一的日志接口
const globalLogger = {
  info: (message: string, ...args: any[]) => console.log('[INFO]', message, ...args),
  warn: (message: string, ...args: any[]) => console.warn('[WARN]', message, ...args),
  error: (message: string, ...args: any[]) => console.error('[ERROR]', message, ...args),
};

// 在组件中使用
globalLogger.info('Component mounted', { componentName: 'UserProfile' });
```

### 错误追踪
- 使用 ErrorBoundary 捕获组件错误
- 实现全局错误处理
- 记录错误日志用于分析

## 部署规范

### 构建配置
- 生产环境构建优化
- 资源压缩和缓存策略
- 环境变量配置

### qiankun 集成
- 确保生命周期函数正确导出
- 配置正确的 publicPath
- 测试微前端集成

## 常见问题

### 1. 状态不更新
**原因**: 可能没有使用 `useSnapshot()` 获取响应式状态
**解决**: 确保在组件中使用 `useSnapshot(settingsStore)`

### 2. 样式不生效
**原因**: CSS 类名冲突或优先级问题
**解决**: 检查 CSS 选择器的特异性，使用更具体的类名

### 3. qiankun 集成问题
**原因**: 生命周期函数导出错误或配置问题
**解决**: 参考 React App 2 的成功配置，确保插件正确配置

### 4. TypeScript 类型错误
**原因**: 类型定义不匹配或缺失
**解决**: 添加正确的类型注解，使用类型断言（谨慎使用）

## 最佳实践

### 1. 组件设计
- 保持组件的单一职责
- 使用合成而非继承
- 提取可复用的逻辑到自定义 Hooks

### 2. 状态管理
- 保持状态结构扁平化
- 避免深层嵌套的状态更新
- 使用 actions 封装复杂操作

### 3. 性能优化
- 避免在渲染函数中创建对象
- 合理使用 React.memo
- 监控应用性能指标

### 4. 代码质量
- 定期进行代码审查
- 使用 ESLint 和 Prettier
- 编写有意义的测试

---

**文档版本**: 1.0  
**最后更新**: 2025-09-26  
**维护人员**: 开发团队