# React App 5 部署指南

## 概述

本文档详细介绍了 React App 5 (设置中心) 的部署流程，包括开发环境、测试环境和生产环境的部署配置。

## 环境要求

### 基础环境
- **Node.js**: >= 16.0.0
- **npm**: >= 8.0.0 或 yarn >= 1.22.0
- **操作系统**: Linux/macOS/Windows
- **浏览器**: Chrome >= 88, Firefox >= 78, Safari >= 14, Edge >= 88

### 服务器环境
- **Web服务器**: Nginx >= 1.18 或 Apache >= 2.4
- **内存**: >= 512MB
- **存储**: >= 100MB
- **网络**: 支持 HTTPS

## 构建配置

### 开发环境构建

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 应用将在 http://localhost:3005 启动
```

### 生产环境构建

```bash
# 安装依赖
npm install --production

# 构建生产版本
npm run build

# 预览生产版本 (可选)
npm run preview
```

### 构建输出

构建完成后，会在 `dist/` 目录生成以下文件：

```
dist/
├── assets/
│   ├── index-[hash].css          # 样式文件
│   ├── index-[hash].js           # 主应用代码
│   ├── index-legacy-[hash].js    # 兼容性代码
│   └── polyfills-legacy-[hash].js # Polyfills
├── index.html                    # HTML入口文件
└── vite.svg                      # 图标文件
```

## 部署配置

### Nginx 配置

#### 基础配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/react-app-5/dist;
    index index.html;

    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理 (如果需要)
    location /api/ {
        proxy_pass http://your-api-server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### HTTPS 配置

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    root /path/to/react-app-5/dist;
    index index.html;

    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 其他配置同上...
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### Apache 配置

#### .htaccess 配置

```apache
# 启用重写引擎
RewriteEngine On

# SPA路由支持
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]

# 启用压缩
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# 静态资源缓存
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/ico "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
</IfModule>
```

## qiankun 微前端部署

### 主应用配置

在主应用中注册 React App 5：

```javascript
// 主应用配置
import { registerMicroApps, start } from 'qiankun';

registerMicroApps([
  {
    name: 'react-settings',
    entry: '//localhost:3005',  // 开发环境
    // entry: '//your-domain.com/react-settings', // 生产环境
    container: '#subapp-container',
    activeRule: '/settings',
  },
]);

start();
```

### 生产环境配置

#### 1. 修改 vite.config.ts

```typescript
export default defineConfig({
  // ... 其他配置
  
  base: process.env.NODE_ENV === 'production' ? '/react-settings/' : '/',
  
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false, // 生产环境关闭sourcemap
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          antd: ['antd'],
          valtio: ['valtio'],
        },
      },
    },
  },
});
```

#### 2. 环境变量配置

创建 `.env.production` 文件：

```bash
# 生产环境配置
NODE_ENV=production
VITE_APP_TITLE=设置中心
VITE_API_BASE_URL=https://api.your-domain.com
VITE_CDN_BASE_URL=https://cdn.your-domain.com
```

#### 3. 部署脚本

创建 `deploy.sh` 脚本：

```bash
#!/bin/bash

# 部署脚本
set -e

echo "开始部署 React App 5..."

# 安装依赖
echo "安装依赖..."
npm ci --production

# 构建应用
echo "构建应用..."
npm run build

# 备份旧版本
if [ -d "/var/www/react-settings" ]; then
    echo "备份旧版本..."
    mv /var/www/react-settings /var/www/react-settings.backup.$(date +%Y%m%d_%H%M%S)
fi

# 部署新版本
echo "部署新版本..."
mkdir -p /var/www/react-settings
cp -r dist/* /var/www/react-settings/

# 设置权限
chown -R www-data:www-data /var/www/react-settings
chmod -R 755 /var/www/react-settings

# 重启Web服务器
echo "重启Nginx..."
systemctl reload nginx

echo "部署完成！"
```

## Docker 部署

### Dockerfile

```dockerfile
# 多阶段构建
FROM node:16-alpine AS builder

WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 生产环境镜像
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动Nginx
CMD ["nginx", "-g", "daemon off;"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  react-app-5:
    build: .
    ports:
      - "3005:80"
    environment:
      - NODE_ENV=production
    volumes:
      - ./logs:/var/log/nginx
    restart: unless-stopped
    
  # 如果需要API服务
  api-server:
    image: your-api-image
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
```

### 构建和运行

```bash
# 构建镜像
docker build -t react-app-5 .

# 运行容器
docker run -d -p 3005:80 --name react-app-5 react-app-5

# 或使用docker-compose
docker-compose up -d
```

## CDN 部署

### 静态资源 CDN

#### 1. 修改构建配置

```typescript
// vite.config.ts
export default defineConfig({
  // ... 其他配置
  
  build: {
    rollupOptions: {
      output: {
        assetFileNames: 'assets/[name].[hash][extname]',
        chunkFileNames: 'assets/[name].[hash].js',
        entryFileNames: 'assets/[name].[hash].js',
      },
    },
  },
  
  // 如果使用CDN
  base: process.env.NODE_ENV === 'production' ? 'https://cdn.your-domain.com/react-settings/' : '/',
});
```

#### 2. 上传到CDN

```bash
# 上传静态资源到CDN (以阿里云OSS为例)
ossutil cp -r dist/ oss://your-bucket/react-settings/ --include="*.js" --include="*.css" --include="*.png" --include="*.jpg" --include="*.svg"
```

## 监控和日志

### 性能监控

#### 1. Web Vitals

```typescript
// 在main.tsx中添加
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

getCLS(console.log);
getFID(console.log);
getFCP(console.log);
getLCP(console.log);
getTTFB(console.log);
```

#### 2. 错误监控

```typescript
// 全局错误处理
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  // 发送到错误监控服务
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  // 发送到错误监控服务
});
```

### 日志配置

#### Nginx 访问日志

```nginx
# 自定义日志格式
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for"';

access_log /var/log/nginx/react-app-5.access.log main;
error_log /var/log/nginx/react-app-5.error.log;
```

## 健康检查

### 应用健康检查

创建健康检查端点：

```typescript
// 在应用中添加健康检查
const healthCheck = {
  status: 'healthy',
  timestamp: new Date().toISOString(),
  version: '1.0.0',
  uptime: process.uptime(),
};

// 可以通过特定路由暴露
```

### 监控脚本

```bash
#!/bin/bash

# 健康检查脚本
URL="https://your-domain.com/react-settings"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL)

if [ $RESPONSE -eq 200 ]; then
    echo "应用运行正常"
    exit 0
else
    echo "应用异常，HTTP状态码: $RESPONSE"
    # 发送告警通知
    exit 1
fi
```

## 回滚策略

### 快速回滚

```bash
#!/bin/bash

# 回滚脚本
BACKUP_DIR="/var/www/react-settings.backup.$(ls -t /var/www/ | grep react-settings.backup | head -1 | cut -d'.' -f3-)"

if [ -d "$BACKUP_DIR" ]; then
    echo "回滚到上一版本..."
    rm -rf /var/www/react-settings
    mv $BACKUP_DIR /var/www/react-settings
    systemctl reload nginx
    echo "回滚完成！"
else
    echo "未找到备份版本！"
    exit 1
fi
```

## 性能优化

### 构建优化

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    // 启用压缩
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true, // 移除console
        drop_debugger: true, // 移除debugger
      },
    },
    
    // 代码分割
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom', 'react-router-dom'],
          ui: ['antd', '@ant-design/icons'],
          utils: ['valtio', 'dayjs', 'lodash'],
        },
      },
    },
    
    // 启用sourcemap (可选)
    sourcemap: false,
  },
});
```

### 缓存策略

```nginx
# 静态资源缓存策略
location ~* \.(js|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
}

location ~* \.(png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# HTML文件不缓存
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}
```

## 安全配置

### 内容安全策略 (CSP)

```nginx
# CSP头部配置
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.your-domain.com;";
```

### 其他安全头

```nginx
# 安全头配置
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Referrer-Policy "strict-origin-when-cross-origin";
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
```

## 故障排除

### 常见问题

#### 1. 白屏问题
- 检查构建产物是否正确
- 检查路径配置是否正确
- 查看浏览器控制台错误

#### 2. 路由问题
- 确保Web服务器配置了SPA路由支持
- 检查base路径配置

#### 3. 资源加载失败
- 检查CDN配置
- 验证CORS设置
- 确认文件权限

#### 4. qiankun集成问题
- 检查生命周期函数导出
- 验证微应用注册配置
- 查看qiankun相关错误日志

### 调试工具

```bash
# 查看Nginx错误日志
tail -f /var/log/nginx/error.log

# 查看访问日志
tail -f /var/log/nginx/access.log

# 测试配置文件
nginx -t

# 重载配置
nginx -s reload
```

## 部署检查清单

- [ ] 环境要求满足
- [ ] 依赖安装完成
- [ ] 构建成功
- [ ] Web服务器配置正确
- [ ] 静态资源可访问
- [ ] 路由功能正常
- [ ] API接口连通
- [ ] qiankun集成正常
- [ ] 错误处理正常
- [ ] 性能指标正常
- [ ] 安全配置完成
- [ ] 监控告警配置
- [ ] 备份恢复测试

---

**文档版本**: 1.0  
**最后更新**: 2025-09-26  
**维护人员**: 运维团队