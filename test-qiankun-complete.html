<!DOCTYPE html>
<html>
<head>
    <title>Qiankun å­åº”ç”¨æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            border: 2px solid #1890ff; 
            padding: 20px; 
            margin: 20px 0; 
            min-height: 200px; 
            background: white;
            border-radius: 8px;
        }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace; 
            border-radius: 4px;
        }
        .error { color: #ff4d4f; }
        .success { color: #52c41a; }
        .info { color: #1890ff; }
        .warning { color: #faad14; }
        .controls {
            margin: 20px 0;
        }
        button {
            margin-right: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #1890ff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #40a9ff;
        }
        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.loading { background: #faad14; color: white; }
        .status.success { background: #52c41a; color: white; }
        .status.error { background: #ff4d4f; color: white; }
    </style>
</head>
<body>
    <h1>ğŸš€ Qiankun å¾®å‰ç«¯å­åº”ç”¨æµ‹è¯•</h1>
    <p>æµ‹è¯• react-app-1 ç”¨æˆ·ç®¡ç†ç³»ç»Ÿåœ¨ qiankun æ¡†æ¶ä¸‹çš„é›†æˆ</p>
    
    <div class="controls">
        <button id="loadBtn" onclick="loadMicroApp()">ğŸ“¦ åŠ è½½å­åº”ç”¨</button>
        <button id="unloadBtn" onclick="unloadMicroApp()" disabled>ğŸ—‘ï¸ å¸è½½å­åº”ç”¨</button>
        <button onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
        <span id="status" class="status" style="display: none;"></span>
    </div>
    
    <h3>ğŸ“‹ è¿è¡Œæ—¥å¿—ï¼š</h3>
    <div id="log-container"></div>
    
    <h3>ğŸ”§ å­åº”ç”¨å®¹å™¨ï¼š</h3>
    <div id="micro-app-react-user-management" class="container">
        <p style="color: #999; text-align: center; margin-top: 80px;">
            å­åº”ç”¨æœªåŠ è½½ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•
        </p>
    </div>
    
    <script src="https://unpkg.com/qiankun@2.10.16/dist/index.js"></script>
    <script>
        const logContainer = document.getElementById('log-container');
        const loadBtn = document.getElementById('loadBtn');
        const unloadBtn = document.getElementById('unloadBtn');
        const statusEl = document.getElementById('status');
        
        let microApp = null;
        let isLoading = false;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log ' + type;
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logContainer.appendChild(div);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function setStatus(text, type) {
            statusEl.textContent = text;
            statusEl.className = 'status ' + type;
            statusEl.style.display = 'inline-block';
        }
        
        function clearStatus() {
            statusEl.style.display = 'none';
        }
        
        function updateButtons(loading = false, loaded = false) {
            loadBtn.disabled = loading || loaded;
            unloadBtn.disabled = loading || !loaded;
            isLoading = loading;
        }
        
        function clearLog() {
            logContainer.innerHTML = '';
            clearStatus();
            log('ğŸ§¹ æ—¥å¿—å·²æ¸…é™¤', 'info');
        }
        
        async function loadMicroApp() {
            if (isLoading) return;
            
            clearLog();
            updateButtons(true, false);
            setStatus('åŠ è½½ä¸­...', 'loading');
            
            log('ğŸš€ å¼€å§‹åŠ è½½ react-app-1 å­åº”ç”¨...', 'info');
            
            try {
                // æ£€æŸ¥å­åº”ç”¨æ˜¯å¦å¯è®¿é—®
                log('ğŸ”— æ£€æŸ¥å­åº”ç”¨å…¥å£åœ°å€...', 'info');
                const response = await fetch('http://localhost:3001/', { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error(`å­åº”ç”¨è¿”å›çŠ¶æ€ç : ${response.status}`);
                }
                log('âœ… å­åº”ç”¨å…¥å£åœ°å€å¯è®¿é—®', 'success');
                
                // æ³¨å†Œå¾®åº”ç”¨
                log('ğŸ“‹ æ³¨å†Œå¾®åº”ç”¨...', 'info');
                qiankun.registerMicroApps([
                    {
                        name: 'react-user-management',
                        entry: 'http://localhost:3001/',
                        container: '#micro-app-react-user-management',
                        activeRule: '/user-management',
                        props: {
                            routerBase: '/user-management',
                            getGlobalState: () => ({ test: 'global state' }),
                            setGlobalState: (state) => console.log('è®¾ç½®å…¨å±€çŠ¶æ€:', state),
                            eventBus: { emit: (event) => console.log('äº‹ä»¶:', event) }
                        }
                    }
                ]);
                log('âœ… å¾®åº”ç”¨æ³¨å†ŒæˆåŠŸ', 'success');
                
                // å¯åŠ¨ qiankun
                log('ğŸš€ å¯åŠ¨ qiankun æ¡†æ¶...', 'info');
                qiankun.start({
                    sandbox: {
                        strictStyleIsolation: false,
                        experimentalStyleIsolation: true
                    },
                    singular: false
                });
                log('âœ… qiankun æ¡†æ¶å¯åŠ¨æˆåŠŸ', 'success');
                
                // æ‰‹åŠ¨åŠ è½½å­åº”ç”¨
                log('ğŸ“¦ æ­£åœ¨åŠ è½½å­åº”ç”¨...', 'info');
                microApp = qiankun.loadMicroApp({
                    name: 'react-user-management',
                    entry: 'http://localhost:3001/',
                    container: '#micro-app-react-user-management',
                    props: {
                        routerBase: '/user-management',
                        testProp: 'Hello from main app'
                    }
                });
                
                // ç­‰å¾…æŒ‚è½½å®Œæˆ
                await microApp.mountPromise;
                log('ğŸ‰ å­åº”ç”¨æŒ‚è½½æˆåŠŸï¼', 'success');
                setStatus('å·²åŠ è½½', 'success');
                updateButtons(false, true);
                
            } catch (error) {
                log('âŒ åŠ è½½å¤±è´¥: ' + error.message, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
                setStatus('åŠ è½½å¤±è´¥', 'error');
                updateButtons(false, false);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åœ¨å®¹å™¨ä¸­
                const container = document.getElementById('micro-app-react-user-management');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ff4d4f;">
                            <h3>âŒ å­åº”ç”¨åŠ è½½å¤±è´¥</h3>
                            <p>${error.message}</p>
                            <p style="font-size: 12px; color: #999;">
                                è¯·ç¡®ä¿å­åº”ç”¨æœåŠ¡æ­£åœ¨è¿è¡Œ: <code>npm run start</code>
                            </p>
                        </div>
                    `;
                }
            }
        }
        
        async function unloadMicroApp() {
            if (isLoading || !microApp) return;
            
            log('ğŸ—‘ï¸ å¼€å§‹å¸è½½å­åº”ç”¨...', 'info');
            updateButtons(true, true);
            setStatus('å¸è½½ä¸­...', 'loading');
            
            try {
                await microApp.unmount();
                log('âœ… å­åº”ç”¨å¸è½½æˆåŠŸ', 'success');
                setStatus('å·²å¸è½½', 'info');
                
                // é‡ç½®å®¹å™¨å†…å®¹
                const container = document.getElementById('micro-app-react-user-management');
                if (container) {
                    container.innerHTML = `
                        <p style="color: #999; text-align: center; margin-top: 80px;">
                            å­åº”ç”¨å·²å¸è½½ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é‡æ–°åŠ è½½
                        </p>
                    `;
                }
                
                microApp = null;
                updateButtons(false, false);
                clearStatus();
                
            } catch (error) {
                log('âŒ å¸è½½å¤±è´¥: ' + error.message, 'error');
                console.error('å¸è½½é”™è¯¯:', error);
                setStatus('å¸è½½å¤±è´¥', 'error');
                updateButtons(false, true);
            }
        }
        
        // ç›‘å¬å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            log('ğŸš¨ å…¨å±€é”™è¯¯: ' + event.error.message, 'error');
            console.error('å…¨å±€é”™è¯¯è¯¦æƒ…:', event.error);
        });
        
        // ç›‘å¬æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            log('âš ï¸ æœªå¤„ç†çš„ Promise æ‹’ç»: ' + event.reason, 'error');
            console.error('Promise æ‹’ç»è¯¦æƒ…:', event.reason);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        log('ğŸ“„ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        log('ğŸ’¡ æç¤ºï¼šç¡®ä¿å­åº”ç”¨æœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆç«¯å£ 3001ï¼‰', 'warning');
    </script>
</body>
</html>