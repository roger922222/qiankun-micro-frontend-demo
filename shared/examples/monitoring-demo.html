<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›‘æ§å’Œé”™è¯¯å¤„ç†ç³»ç»Ÿæ¼”ç¤º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        .btn-success {
            background: #52c41a;
            color: white;
        }
        .btn-warning {
            background: #faad14;
            color: white;
        }
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        button:hover {
            opacity: 0.8;
        }
        .monitor-container {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            min-height: 200px;
            background: #fafafa;
        }
        .error-container {
            border: 1px solid #ff4d4f;
            border-radius: 4px;
            min-height: 100px;
            background: #fff2f0;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¾®å‰ç«¯ç›‘æ§å’Œé”™è¯¯å¤„ç†ç³»ç»Ÿæ¼”ç¤º</h1>
        
        <!-- æ€§èƒ½ç›‘æ§æ¼”ç¤º -->
        <div class="section">
            <h2>æ€§èƒ½ç›‘æ§ç³»ç»Ÿ</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="startPerformanceMonitoring()">å¯åŠ¨ç›‘æ§</button>
                <button class="btn-success" onclick="simulateEvents()">æ¨¡æ‹Ÿäº‹ä»¶</button>
                <button class="btn-warning" onclick="simulateStateUpdates()">æ¨¡æ‹ŸçŠ¶æ€æ›´æ–°</button>
                <button class="btn-danger" onclick="clearMonitoringData()">æ¸…é™¤æ•°æ®</button>
            </div>
            <div id="performance-monitor" class="monitor-container"></div>
        </div>

        <!-- é”™è¯¯å¤„ç†æ¼”ç¤º -->
        <div class="section">
            <h2>é”™è¯¯å¤„ç†ç³»ç»Ÿ</h2>
            <div class="button-group">
                <button class="btn-danger" onclick="triggerError('runtime')">è§¦å‘è¿è¡Œæ—¶é”™è¯¯</button>
                <button class="btn-danger" onclick="triggerError('network')">è§¦å‘ç½‘ç»œé”™è¯¯</button>
                <button class="btn-danger" onclick="triggerError('validation')">è§¦å‘éªŒè¯é”™è¯¯</button>
                <button class="btn-primary" onclick="createRecoveryPoint()">åˆ›å»ºæ¢å¤ç‚¹</button>
                <button class="btn-warning" onclick="testRetryMechanism()">æµ‹è¯•é‡è¯•æœºåˆ¶</button>
            </div>
            <div id="error-boundary" class="error-container"></div>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="section">
            <h2>ç³»ç»Ÿæ—¥å¿—</h2>
            <button class="btn-primary" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <!-- åŠ è½½ç›‘æ§å’Œé”™è¯¯å¤„ç†ç³»ç»Ÿ -->
    <script type="module">
        // æ¨¡æ‹ŸåŠ è½½ç›‘æ§ç³»ç»Ÿ
        window.monitoringSystem = {
            performanceMonitor: null,
            errorBoundary: null,
            initialized: false
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            // æ¨¡æ‹Ÿæ€§èƒ½ç›‘æ§å™¨
            window.monitoringSystem.performanceMonitor = {
                enabled: false,
                metrics: [],
                
                start() {
                    this.enabled = true;
                    log('âœ… æ€§èƒ½ç›‘æ§å·²å¯åŠ¨');
                    this.updateDisplay();
                },
                
                addMetric(type, name, duration, metadata = {}) {
                    if (!this.enabled) return;
                    
                    const metric = {
                        id: `metric_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        timestamp: new Date().toISOString(),
                        type,
                        name,
                        duration,
                        metadata
                    };
                    
                    this.metrics.push(metric);
                    if (this.metrics.length > 100) {
                        this.metrics = this.metrics.slice(-100);
                    }
                    
                    log(`ğŸ“Š æ–°å¢æŒ‡æ ‡: ${type} - ${name} (${duration.toFixed(2)}ms)`);
                    this.updateDisplay();
                },
                
                clear() {
                    this.metrics = [];
                    log('ğŸ—‘ï¸ ç›‘æ§æ•°æ®å·²æ¸…é™¤');
                    this.updateDisplay();
                },
                
                updateDisplay() {
                    const container = document.getElementById('performance-monitor');
                    if (!container) return;
                    
                    const eventMetrics = this.metrics.filter(m => m.type === 'event');
                    const stateMetrics = this.metrics.filter(m => m.type === 'state');
                    
                    const avgEventDuration = eventMetrics.length > 0 
                        ? eventMetrics.reduce((sum, m) => sum + m.duration, 0) / eventMetrics.length 
                        : 0;
                    
                    const avgStateDuration = stateMetrics.length > 0
                        ? stateMetrics.reduce((sum, m) => sum + m.duration, 0) / stateMetrics.length
                        : 0;
                    
                    container.innerHTML = `
                        <div style="padding: 16px;">
                            <h3 style="margin-top: 0;">å®æ—¶æ€§èƒ½ç›‘æ§</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e8e8e8;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">æ€»äº‹ä»¶æ•°</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #333;">${eventMetrics.length}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e8e8e8;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">å¹³å‡äº‹ä»¶å¤„ç†æ—¶é—´</div>
                                    <div style="font-size: 20px; font-weight: bold; color: ${avgEventDuration > 10 ? '#ff4d4f' : '#52c41a'};">${avgEventDuration.toFixed(2)}ms</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e8e8e8;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">çŠ¶æ€æ›´æ–°æ•°</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #333;">${stateMetrics.length}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e8e8e8;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">å¹³å‡çŠ¶æ€æ›´æ–°æ—¶é—´</div>
                                    <div style="font-size: 20px; font-weight: bold; color: ${avgStateDuration > 5 ? '#ff4d4f' : '#52c41a'};">${avgStateDuration.toFixed(2)}ms</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h4>æœ€è¿‘æŒ‡æ ‡ (æœ€æ–°10æ¡)</h4>
                                <div style="max-height: 150px; overflow-y: auto; font-size: 12px; font-family: monospace;">
                                    ${this.metrics.slice(-10).reverse().map(m => 
                                        `<div style="padding: 4px; border-bottom: 1px solid #f0f0f0;">
                                            ${new Date(m.timestamp).toLocaleTimeString()} - ${m.type} - ${m.name} (${m.duration.toFixed(2)}ms)
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            };

            // æ¨¡æ‹Ÿé”™è¯¯è¾¹ç•Œ
            window.monitoringSystem.errorBoundary = {
                errors: [],
                recoveryPoints: [],
                
                handleError(error, context = {}) {
                    const errorInfo = {
                        id: `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        timestamp: new Date().toISOString(),
                        message: error.message,
                        type: context.type || 'runtime-error',
                        level: context.level || 'medium',
                        context
                    };
                    
                    this.errors.push(errorInfo);
                    if (this.errors.length > 50) {
                        this.errors = this.errors.slice(-50);
                    }
                    
                    log(`âŒ é”™è¯¯æ•è·: ${errorInfo.type} - ${errorInfo.message}`);
                    this.updateDisplay();
                    
                    return errorInfo;
                },
                
                createRecoveryPoint(description) {
                    const point = {
                        id: `recovery_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        timestamp: new Date().toISOString(),
                        description,
                        state: { /* æ¨¡æ‹ŸçŠ¶æ€å¿«ç…§ */ }
                    };
                    
                    this.recoveryPoints.push(point);
                    if (this.recoveryPoints.length > 20) {
                        this.recoveryPoints = this.recoveryPoints.slice(-20);
                    }
                    
                    log(`ğŸ’¾ æ¢å¤ç‚¹å·²åˆ›å»º: ${description}`);
                    return point.id;
                },
                
                async retry(fn, maxRetries = 3) {
                    let attempts = 0;
                    let lastError = null;
                    
                    while (attempts < maxRetries) {
                        attempts++;
                        try {
                            const result = await fn();
                            log(`âœ… é‡è¯•æˆåŠŸ (ç¬¬${attempts}æ¬¡å°è¯•)`);
                            return { success: true, result, attempts };
                        } catch (error) {
                            lastError = error;
                            log(`âš ï¸ é‡è¯•å¤±è´¥ (ç¬¬${attempts}æ¬¡å°è¯•): ${error.message}`);
                            
                            if (attempts < maxRetries) {
                                const delay = Math.pow(2, attempts - 1) * 1000; // æŒ‡æ•°é€€é¿
                                await new Promise(resolve => setTimeout(resolve, delay));
                            }
                        }
                    }
                    
                    log(`âŒ é‡è¯•æœ€ç»ˆå¤±è´¥ (${attempts}æ¬¡å°è¯•)`);
                    return { success: false, error: lastError, attempts };
                },
                
                updateDisplay() {
                    const container = document.getElementById('error-boundary');
                    if (!container) return;
                    
                    const recentErrors = this.errors.slice(-5);
                    
                    container.innerHTML = `
                        <div style="padding: 16px;">
                            <h3 style="margin-top: 0;">é”™è¯¯å¤„ç†çŠ¶æ€</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e8e8e8;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">æ€»é”™è¯¯æ•°</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ff4d4f;">${this.errors.length}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e8e8e8;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">æ¢å¤ç‚¹æ•°</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #52c41a;">${this.recoveryPoints.length}</div>
                                </div>
                            </div>
                            ${recentErrors.length > 0 ? `
                                <h4>æœ€è¿‘é”™è¯¯</h4>
                                <div style="max-height: 120px; overflow-y: auto;">
                                    ${recentErrors.reverse().map(error => `
                                        <div style="background: white; padding: 8px; margin: 4px 0; border-radius: 4px; border-left: 4px solid #ff4d4f; font-size: 12px;">
                                            <div style="font-weight: bold;">${error.type}</div>
                                            <div style="color: #666; margin: 2px 0;">${error.message}</div>
                                            <div style="color: #999; font-size: 10px;">${new Date(error.timestamp).toLocaleString()}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— é”™è¯¯è®°å½•</div>'}
                        </div>
                    `;
                }
            };

            window.monitoringSystem.initialized = true;
            log('ğŸš€ ç›‘æ§å’Œé”™è¯¯å¤„ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logsContainer = document.getElementById('logs');
            if (!logsContainer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // å…¨å±€å‡½æ•°
        window.startPerformanceMonitoring = function() {
            if (!window.monitoringSystem.initialized) {
                initializeSystem();
            }
            window.monitoringSystem.performanceMonitor.start();
        };

        window.simulateEvents = function() {
            const monitor = window.monitoringSystem.performanceMonitor;
            if (!monitor.enabled) {
                log('âš ï¸ è¯·å…ˆå¯åŠ¨æ€§èƒ½ç›‘æ§');
                return;
            }
            
            // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„äº‹ä»¶
            const events = [
                { name: 'USER_LOGIN', duration: Math.random() * 20 + 5 },
                { name: 'DATA_FETCH', duration: Math.random() * 50 + 10 },
                { name: 'ROUTE_CHANGE', duration: Math.random() * 15 + 3 },
                { name: 'COMPONENT_RENDER', duration: Math.random() * 8 + 2 }
            ];
            
            events.forEach((event, index) => {
                setTimeout(() => {
                    monitor.addMetric('event', event.name, event.duration, {
                        source: 'simulation',
                        batch: Date.now()
                    });
                }, index * 200);
            });
        };

        window.simulateStateUpdates = function() {
            const monitor = window.monitoringSystem.performanceMonitor;
            if (!monitor.enabled) {
                log('âš ï¸ è¯·å…ˆå¯åŠ¨æ€§èƒ½ç›‘æ§');
                return;
            }
            
            // æ¨¡æ‹ŸçŠ¶æ€æ›´æ–°
            const updates = [
                { name: 'UPDATE_USER_PROFILE', duration: Math.random() * 10 + 2 },
                { name: 'UPDATE_THEME', duration: Math.random() * 5 + 1 },
                { name: 'UPDATE_PERMISSIONS', duration: Math.random() * 15 + 3 }
            ];
            
            updates.forEach((update, index) => {
                setTimeout(() => {
                    monitor.addMetric('state', update.name, update.duration, {
                        source: 'simulation',
                        stateSize: Math.floor(Math.random() * 1000) + 100
                    });
                }, index * 300);
            });
        };

        window.clearMonitoringData = function() {
            if (window.monitoringSystem.performanceMonitor) {
                window.monitoringSystem.performanceMonitor.clear();
            }
        };

        window.triggerError = function(type) {
            if (!window.monitoringSystem.initialized) {
                initializeSystem();
            }
            
            const errorBoundary = window.monitoringSystem.errorBoundary;
            let error;
            
            switch (type) {
                case 'runtime':
                    error = new Error('æ¨¡æ‹Ÿè¿è¡Œæ—¶é”™è¯¯: æœªå®šä¹‰çš„å˜é‡è®¿é—®');
                    errorBoundary.handleError(error, { type: 'runtime-error', level: 'high' });
                    break;
                case 'network':
                    error = new Error('æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯: è¯·æ±‚è¶…æ—¶');
                    errorBoundary.handleError(error, { type: 'network-error', level: 'medium' });
                    break;
                case 'validation':
                    error = new Error('æ¨¡æ‹ŸéªŒè¯é”™è¯¯: æ— æ•ˆçš„ç”¨æˆ·è¾“å…¥');
                    errorBoundary.handleError(error, { type: 'validation-error', level: 'low' });
                    break;
            }
        };

        window.createRecoveryPoint = function() {
            if (!window.monitoringSystem.initialized) {
                initializeSystem();
            }
            
            const description = `æ‰‹åŠ¨æ¢å¤ç‚¹ - ${new Date().toLocaleTimeString()}`;
            window.monitoringSystem.errorBoundary.createRecoveryPoint(description);
        };

        window.testRetryMechanism = function() {
            if (!window.monitoringSystem.initialized) {
                initializeSystem();
            }
            
            const errorBoundary = window.monitoringSystem.errorBoundary;
            
            // æ¨¡æ‹Ÿä¸€ä¸ªå¯èƒ½å¤±è´¥çš„æ“ä½œ
            let attemptCount = 0;
            const unreliableOperation = () => {
                attemptCount++;
                if (attemptCount < 3) {
                    throw new Error(`æ¨¡æ‹Ÿå¤±è´¥ (å°è¯• ${attemptCount})`);
                }
                return `æˆåŠŸç»“æœ (ç¬¬${attemptCount}æ¬¡å°è¯•)`;
            };
            
            log('ğŸ”„ å¼€å§‹æµ‹è¯•é‡è¯•æœºåˆ¶...');
            errorBoundary.retry(unreliableOperation, 5).then(result => {
                if (result.success) {
                    log(`âœ… é‡è¯•æœºåˆ¶æµ‹è¯•æˆåŠŸ: ${result.result}`);
                } else {
                    log(`âŒ é‡è¯•æœºåˆ¶æµ‹è¯•å¤±è´¥: ${result.error.message}`);
                }
            });
        };

        window.clearLogs = function() {
            const logsContainer = document.getElementById('logs');
            if (logsContainer) {
                logsContainer.innerHTML = '';
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œç›‘æ§æ¼”ç¤ºç³»ç»Ÿå°±ç»ª');
            log('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½');
        });
    </script>
</body>
</html>